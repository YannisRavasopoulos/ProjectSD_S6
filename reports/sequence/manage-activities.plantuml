@startuml
actor User
participant HomeView
participant ActivitiesView
participant ActivitiesViewModel
participant ActivityRepository
participant CreateActivityView
participant CreateActivityViewModel
participant ActivityDeletionDialog
participant Activity

' ViewModels are active for the whole session
activate ActivitiesViewModel
activate ActivityRepository

alt Main Flow: View and Create Activity
    User -> HomeView: Selects "Activities"
    activate HomeView
    HomeView -> ActivitiesView: pushNamed('/activities')
    activate ActivitiesView
    ActivitiesView -> ActivitiesViewModel: loadActivities()
    ActivitiesViewModel -> ActivityRepository: fetch()

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> ActivitiesViewModel: List<Activity>
    ActivitiesViewModel --> ActivitiesView: notifyListeners()
    ActivitiesView -> ActivitiesView: Shows list of Activities

    User -> ActivitiesView: Presses "Create"
    ActivitiesView -> CreateActivityView: pushNamed('/activities/create')
    activate CreateActivityView
    CreateActivityView -> CreateActivityViewModel: (init)
    activate CreateActivityViewModel 

    User -> CreateActivityView: Fills details and presses "Create Activity"
    CreateActivityView -> CreateActivityViewModel: createActivity()
    CreateActivityViewModel -> ActivityRepository: create(activity)

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> CreateActivityViewModel: success
    CreateActivityViewModel --> CreateActivityView: notifyListeners()
    CreateActivityView -> ActivitiesView: Navigator.pop(context, true)
    deactivate CreateActivityView

    ActivitiesView -> ActivitiesViewModel: loadActivities()
    ActivitiesViewModel -> ActivityRepository: fetch()

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> ActivitiesViewModel: List<Activity>
    ActivitiesViewModel --> ActivitiesView: notifyListeners()
    ActivitiesView -> ActivitiesView: Updated list of Activities
    deactivate HomeView
end alt

alt Alternative Flow: Invalid Data
    User -> CreateActivityView: Presses "Create Activity" with invalid data
    activate CreateActivityView
    CreateActivityView -> CreateActivityViewModel: createActivity()
    CreateActivityViewModel --> CreateActivityView: notifyListeners()

    User -> CreateActivityView: Corrects data and presses "Create Activity" again
    CreateActivityView -> CreateActivityViewModel: createActivity()
    CreateActivityViewModel -> ActivityRepository: create(activity)

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> CreateActivityViewModel: success
    CreateActivityViewModel --> CreateActivityView: notifyListeners()
    CreateActivityView -> ActivitiesView: Navigator.pop(context, true)
    deactivate CreateActivityView

    ActivitiesView -> ActivitiesViewModel: loadActivities()
    ActivitiesViewModel -> ActivityRepository: fetch()

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> ActivitiesViewModel: List<Activity>
    ActivitiesViewModel --> ActivitiesView: notifyListeners()
    ActivitiesView -> ActivitiesView: Updated list of Activities
end alt

alt Alternative Flow: Edit Activity
    User -> ActivitiesView: Presses "Edit" on Activity
    ActivitiesView -> CreateActivityView: pushNamed('/activities/edit', arguments: activity)
    activate CreateActivityView
    CreateActivityView -> CreateActivityViewModel: (init with activity)

    User -> CreateActivityView: Changes details and presses "Update Activity"
    CreateActivityView -> CreateActivityViewModel: editActivity()
    CreateActivityViewModel -> ActivityRepository: update(activity)

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> CreateActivityViewModel: success
    CreateActivityViewModel --> CreateActivityView: notifyListeners()
    CreateActivityView -> ActivitiesView: Navigator.pop(context, true)
    deactivate CreateActivityView

    ActivitiesView -> ActivitiesViewModel: loadActivities()
    ActivitiesViewModel -> ActivityRepository: fetch()

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> ActivitiesViewModel: List<Activity>
    ActivitiesViewModel --> ActivitiesView: notifyListeners()
    ActivitiesView -> ActivitiesView: Updated list of Activities
end alt

alt Alternative Flow: Delete Activity
    activate ActivitiesView
    User -> ActivitiesView: Presses "Delete" on Activity
    ActivitiesView -> ActivityDeletionDialog: showDialog()
    activate ActivityDeletionDialog
    User -> ActivityDeletionDialog: Confirms deletion
    ActivityDeletionDialog -> ActivitiesView: onConfirm()
    deactivate ActivityDeletionDialog
    ActivitiesView -> ActivitiesViewModel: deleteActivity(activity)
    ActivitiesViewModel -> ActivityRepository: delete(activity)

    ActivityRepository --> Activity: instantiate
    activate Activity
    Activity -> Activity: Activity()
    deactivate Activity

    ActivityRepository --> ActivitiesViewModel: success
    ActivitiesViewModel --> ActivitiesView: notifyListeners()
    ActivitiesView -> ActivitiesView: Updated list of Activities
end alt

deactivate ActivitiesViewModel
deactivate CreateActivityViewModel
@enduml